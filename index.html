<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude AI Chat - –ì–æ–ª–æ—Å–æ–≤–æ–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --bg-sidebar: #141414;
            --text-primary: #fafafa;
            --text-secondary: #888;
            --accent: #d97757;
            --accent-hover: #e88a6a;
            --accent-glow: rgba(217, 119, 87, 0.3);
            --user-bubble: #2a2a2a;
            --ai-bubble: transparent;
            --border: #333;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --thinking-bg: #1a2d4a;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            overscroll-behavior: none;
        }

        .app-wrapper {
            display: flex;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 200;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .new-chat-btn-sidebar {
            width: 100%;
            padding: 12px 16px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .new-chat-btn-sidebar:hover {
            background: var(--accent-hover);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .sidebar-chats {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
        }

        .chat-item {
            padding: 12px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .chat-item:hover {
            background: var(--bg-tertiary);
        }

        .chat-item.active {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .chat-item-content {
            flex: 1;
            min-width: 0;
        }

        .chat-item-title {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item-date {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chat-item-delete {
            opacity: 0;
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }

        .chat-item-delete:hover {
            background: var(--error);
            color: white;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-overlay.show {
                display: block;
            }
        }

        .app-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            height: 100vh;
            height: 100dvh;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .menu-btn:hover {
            background: var(--bg-tertiary);
        }

        @media (max-width: 768px) {
            .menu-btn {
                display: flex;
            }
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent), #e8a088);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .app-title {
            font-size: 18px;
            font-weight: 600;
        }

        @media (max-width: 500px) {
            .app-title {
                display: none;
            }
        }

        .model-selector {
            position: relative;
        }

        .model-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-btn:hover {
            background: var(--user-bubble);
        }

        .model-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .model-dropdown.show {
            display: block;
        }

        .model-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-bottom: 1px solid var(--border);
        }

        .model-option:last-child {
            border-bottom: none;
        }

        .model-option:hover {
            background: var(--bg-tertiary);
        }

        .model-option.selected {
            background: rgba(217, 119, 87, 0.2);
        }

        .model-name {
            font-weight: 500;
            font-size: 14px;
        }

        .model-desc {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .model-badges {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
        }

        .badge.vision { background: #2563eb20; color: #60a5fa; }
        .badge.reasoning { background: #7c3aed20; color: #a78bfa; }

        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            padding-bottom: 100px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            text-align: center;
            padding: 40px 20px;
        }

        .welcome-logo {
            width: 90px;
            height: 90px;
            background: linear-gradient(135deg, var(--accent), #e8a088);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            color: white;
            margin-bottom: 28px;
            box-shadow: 0 15px 50px var(--accent-glow), 0 5px 20px rgba(0,0,0,0.3);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff, #ccc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            max-width: 450px;
            line-height: 1.6;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 36px;
            max-width: 650px;
        }

        .suggestion-btn {
            padding: 14px 20px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .suggestion-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .suggestion-btn:active {
            transform: translateY(0);
        }

        /* Messages */
        .message {
            margin-bottom: 24px;
            animation: messageIn 0.4s ease;
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .message-avatar {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            color: white;
        }

        .message-avatar.ai {
            background: linear-gradient(135deg, var(--accent), #e8a088);
            color: white;
            box-shadow: 0 3px 10px var(--accent-glow);
        }

        .message-role {
            font-weight: 600;
            font-size: 14px;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.75;
            font-size: 15px;
        }

        .message.user .message-content {
            background: var(--user-bubble);
            margin-left: 44px;
            border: 1px solid var(--border);
        }

        .message.assistant .message-content {
            background: transparent;
            margin-left: 44px;
            padding-left: 0;
            padding-right: 0;
        }

        /* Thinking Block */
        .thinking-block {
            background: var(--thinking-bg);
            border: 1px solid #2563eb40;
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #93c5fd;
        }

        .thinking-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 600;
            color: #60a5fa;
        }

        .thinking-header svg {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .thinking-content {
            white-space: pre-wrap;
            opacity: 0.9;
        }

        /* Code Blocks */
        .message-content pre {
            background: #0d1117;
            border-radius: 10px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }

        .message-content code {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 13px;
        }

        .message-content p code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .copy-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 6px 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
        }

        pre:hover .copy-btn {
            opacity: 1;
        }

        .copy-btn:hover {
            background: var(--user-bubble);
            color: var(--text-primary);
        }

        .copy-btn.copied {
            color: var(--success);
        }

        /* Math */
        .katex-display {
            margin: 16px 0;
            overflow-x: auto;
        }

        /* Message Actions */
        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            margin-left: 42px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Input Area */
        .input-area {
            padding: 16px;
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 10px 14px;
            transition: all 0.2s;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-container:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .input-actions-left {
            display: flex;
            gap: 6px;
        }

        .input-icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .input-icon-btn:hover {
            background: var(--user-bubble);
            color: var(--text-primary);
        }

        .input-icon-btn.active {
            background: var(--accent);
            color: white;
        }

        .input-icon-btn svg {
            width: 20px;
            height: 20px;
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            min-height: 24px;
            max-height: 150px;
            font-family: inherit;
            line-height: 1.5;
        }

        #messageInput::placeholder {
            color: var(--text-secondary);
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--accent-hover);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Voice Mode Overlay */
        .voice-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #0a0a12 0%, #0f1419 50%, #1a1520 100%);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .voice-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .voice-close-btn {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            width: 44px;
            height: 44px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .voice-close-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .voice-visualizer {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #e8a088);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 50px;
            box-shadow: 0 0 60px var(--accent-glow), 0 0 100px rgba(217, 119, 87, 0.2);
        }

        .voice-visualizer::before,
        .voice-visualizer::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: inherit;
            opacity: 0;
        }

        .voice-visualizer::after {
            animation-delay: 0.5s;
        }

        .voice-visualizer.listening::before {
            animation: voicePulse 2s ease-out infinite;
        }

        .voice-visualizer.listening::after {
            animation: voicePulse 2s ease-out infinite 0.7s;
        }

        .voice-visualizer.speaking::before {
            animation: voicePulseFast 0.8s ease-out infinite;
        }

        .voice-visualizer.speaking::after {
            animation: voicePulseFast 0.8s ease-out infinite 0.3s;
        }

        .voice-visualizer.analyzing::before {
            animation: voiceAnalyze 1.5s ease-in-out infinite;
        }

        @keyframes voicePulse {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        @keyframes voicePulseFast {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.4); opacity: 0; }
        }

        @keyframes voiceAnalyze {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .voice-icon {
            width: 90px;
            height: 90px;
            color: white;
        }

        .voice-status {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
            background: linear-gradient(90deg, #fff, #ddd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .voice-text {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 400px;
            text-align: center;
            min-height: 60px;
            line-height: 1.5;
            padding: 0 20px;
        }

        .voice-response {
            font-size: 15px;
            color: var(--text-primary);
            max-width: 500px;
            text-align: center;
            margin-top: 20px;
            padding: 16px 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .voice-controls {
            display: flex;
            gap: 20px;
            margin-top: 50px;
            position: fixed;
            bottom: 50px;
        }

        .voice-control-btn {
            width: 64px;
            height: 64px;
            border: none;
            background: rgba(255,255,255,0.08);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .voice-control-btn:hover {
            background: rgba(255,255,255,0.15);
            transform: scale(1.1);
        }

        .voice-control-btn.active {
            background: var(--accent);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        .voice-control-btn.danger {
            background: var(--error);
        }

        .voice-control-btn svg {
            width: 28px;
            height: 28px;
        }

        /* Video Preview */
        .video-container {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 180px;
            height: 240px;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid var(--accent);
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), 0 0 30px var(--accent-glow);
        }

        .video-container.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #videoPreview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            color: white;
            backdrop-filter: blur(5px);
        }

        /* Image Preview */
        .image-preview-container {
            display: none;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 16px 16px 0 0;
            margin-bottom: -1px;
        }

        .image-preview-container.show {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .image-preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 22px;
            height: 22px;
            background: rgba(0,0,0,0.6);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Loading */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
            margin-left: 42px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(1); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 10px 12px;
            }

            .model-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .model-dropdown {
                position: fixed;
                left: 10px;
                right: 10px;
                top: 60px;
                min-width: auto;
            }

            .chat-container {
                padding: 12px;
                padding-bottom: 120px;
            }

            .message-content {
                padding: 14px 16px;
                font-size: 15px;
            }

            .message.user .message-content,
            .message.assistant .message-content {
                margin-left: 0;
            }

            .message-header {
                margin-bottom: 6px;
            }

            .message-actions {
                margin-left: 0;
                flex-wrap: wrap;
            }

            .input-area {
                padding: 10px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }

            .input-container {
                padding: 8px 12px;
            }

            .welcome-title {
                font-size: 24px;
            }

            .welcome-subtitle {
                font-size: 14px;
            }

            .suggestions {
                gap: 8px;
            }

            .suggestion-btn {
                padding: 10px 14px;
                font-size: 13px;
            }

            .voice-visualizer {
                width: 160px;
                height: 160px;
            }

            .voice-icon {
                width: 70px;
                height: 70px;
            }

            .video-container {
                width: 120px;
                height: 160px;
                top: 70px;
                right: 15px;
            }

            .voice-controls {
                bottom: max(40px, env(safe-area-inset-bottom));
            }

            .voice-response {
                max-width: 90%;
                font-size: 14px;
            }
        }

        @media (max-width: 400px) {
            .logo {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            .suggestion-btn {
                width: 100%;
            }
        }

        /* File input hidden */
        #imageInput {
            display: none;
        }

        /* Fraction styling */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            font-size: 0.85em;
            margin: 0 2px;
        }

        .fraction .numerator {
            border-bottom: 1px solid currentColor;
            padding: 0 4px 2px;
        }

        .fraction .denominator {
            padding: 2px 4px 0;
        }

        /* Lists */
        .message-content ul, .message-content ol {
            margin: 12px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 6px 0;
        }

        .message-content h1, .message-content h2, .message-content h3 {
            margin: 16px 0 8px;
        }

        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.1em; }

        .message-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 16px;
            margin: 12px 0;
            color: var(--text-secondary);
        }

        .message-content table {
            border-collapse: collapse;
            margin: 12px 0;
            width: 100%;
            overflow-x: auto;
            display: block;
        }

        .message-content th, .message-content td {
            border: 1px solid var(--border);
            padding: 8px 12px;
            text-align: left;
        }

        .message-content th {
            background: var(--bg-tertiary);
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 16px 0;
        }

        .message-content a {
            color: var(--accent);
            text-decoration: none;
        }

        .message-content a:hover {
            text-decoration: underline;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 10px;
            margin: 12px 0;
        }

        /* Attached image in message */
        .attached-images {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .attached-image {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            object-fit: cover;
        }

        /* Stop button */
        .stop-btn {
            display: none;
            width: 40px;
            height: 40px;
            border: none;
            background: var(--error);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .stop-btn.show {
            display: flex;
        }

        .stop-btn:hover {
            background: #dc2626;
        }

        .stop-btn svg {
            width: 16px;
            height: 16px;
        }

        /* New chat button */
        .new-chat-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .new-chat-btn svg {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- Sidebar -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn-sidebar" onclick="newChat()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    –ù–æ–≤—ã–π —á–∞—Ç
                </button>
            </div>
            <div class="sidebar-chats" id="sidebarChats">
                <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
            </div>
        </aside>

        <div class="app-container">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-btn" onclick="toggleSidebar()">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12h18M3 6h18M3 18h18"/>
                        </svg>
                    </button>
                    <div class="logo">C</div>
                    <span class="app-title">Claude AI</span>
                </div>
                <div class="model-selector">
                    <button class="model-btn" onclick="toggleModelDropdown()">
                        <span id="selectedModel">Claude Sonnet 4.5</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6"/>
                        </svg>
                    </button>
                    <div class="model-dropdown" id="modelDropdown">
                        <div class="model-option selected" data-model="claude" onclick="selectModel('claude', 'Claude Sonnet 4.5')">
                            <span class="model-name">Claude Sonnet 4.5</span>
                            <span class="model-desc">–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á</span>
                            <div class="model-badges">
                                <span class="badge vision">üëÅÔ∏è Vision</span>
                            </div>
                        </div>
                        <div class="model-option" data-model="claude-fast" onclick="selectModel('claude-fast', 'Claude Haiku 4.5')">
                            <span class="model-name">Claude Haiku 4.5</span>
                            <span class="model-desc">–ë—ã—Å—Ç—Ä–∞—è –∏ —ç–∫–æ–Ω–æ–º–∏—á–Ω–∞—è –º–æ–¥–µ–ª—å</span>
                            <div class="model-badges">
                                <span class="badge vision">üëÅÔ∏è Vision</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

        <!-- Chat Container -->
        <div class="chat-container" id="chatContainer">
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-logo">C</div>
                <h1 class="welcome-title">–ü—Ä–∏–≤–µ—Ç! –Ø Claude</h1>
                <p class="welcome-subtitle">–Ø –º–æ–≥—É –ø–æ–º–æ—á—å —Å –∫–æ–¥–æ–º, –∞–Ω–∞–ª–∏–∑–æ–º, —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º–∏ –∑–∞–¥–∞—á–∞–º–∏ –∏ –º–Ω–æ–≥–∏–º –¥—Ä—É–≥–∏–º. –ú–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å!</p>
                <div class="suggestions">
                    <button class="suggestion-btn" onclick="sendSuggestion('–ù–∞–ø–∏—à–∏ –∫–æ–¥ –∏–≥—Ä—ã –∑–º–µ–π–∫–∞ –Ω–∞ JavaScript')">üéÆ –ò–≥—Ä–∞ –∑–º–µ–π–∫–∞</button>
                    <button class="suggestion-btn" onclick="sendSuggestion('–û–±—ä—è—Å–Ω–∏ –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏')">üî¨ –ö–≤–∞–Ω—Ç–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è</button>
                    <button class="suggestion-btn" onclick="sendSuggestion('–ü–æ–º–æ–≥–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –∏–∑—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è')">üìö –ü–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è</button>
                    <button class="suggestion-btn" onclick="sendSuggestion('–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–π —Ä–∞—Å—Å–∫–∞–∑ –æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏')">‚úçÔ∏è –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ</button>
                </div>
            </div>
            <div id="messagesContainer"></div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="image-preview-container" id="imagePreviewContainer"></div>
            <div class="input-container">
                <div class="input-actions-left">
                    <button class="input-icon-btn" onclick="triggerImageUpload()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </button>
                    <button class="input-icon-btn" id="voiceBtn" onclick="startVoiceMode()" title="–ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                            <line x1="12" y1="19" x2="12" y2="23"/>
                            <line x1="8" y1="23" x2="16" y2="23"/>
                        </svg>
                    </button>
                </div>
                <textarea id="messageInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                <input type="file" id="imageInput" accept="image/*" multiple onchange="handleImageSelect(event)">
                <button class="stop-btn" id="stopBtn" onclick="stopGeneration()" title="–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                </button>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
        </div>
        </div>
    </div>

    <!-- Voice Mode Overlay -->
    <div class="voice-overlay" id="voiceOverlay">
        <button class="voice-close-btn" onclick="closeVoiceMode()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
        </button>
        <div class="video-container" id="videoContainer">
            <video id="videoPreview" autoplay muted playsinline></video>
            <div class="video-label">–ö–∞–º–µ—Ä–∞</div>
        </div>
        <div class="voice-visualizer" id="voiceVisualizer">
            <svg class="voice-icon" id="voiceIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                <line x1="12" y1="19" x2="12" y2="23"/>
                <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
        </div>
        <div class="voice-status" id="voiceStatus">–°–ª—É—à–∞—é...</div>
        <div class="voice-text" id="voiceText"></div>
        <div class="voice-response" id="voiceResponse" style="display:none;"></div>
        <div class="voice-controls">
            <button class="voice-control-btn" id="videoToggle" onclick="toggleVideo()" title="–ö–∞–º–µ—Ä–∞">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="23 7 16 12 23 17 23 7"/>
                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
                </svg>
            </button>
            <button class="voice-control-btn active" id="micToggle" onclick="toggleMic()" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                    <line x1="12" y1="19" x2="12" y2="23"/>
                    <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
            </button>
            <button class="voice-control-btn danger" onclick="closeVoiceMode()" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" transform="rotate(135 12 12)"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Configuration
        const API_KEY = 'sk_MIrJoVngM6GGtVhfAbmYFlRvOAHCllqc';
        const API_URL = 'https://gen.pollinations.ai/v1/chat/completions';

        // State
        let currentModel = 'claude';
        let messages = [];
        let isGenerating = false;
        let abortController = null;
        let attachedImages = [];

        // Chat history state
        let chats = [];
        let currentChatId = null;

        // Voice state
        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isVoiceMode = false;
        let isListening = false;
        let isSpeaking = false;
        let mediaStream = null;
        let isVideoEnabled = false;
        let isMicEnabled = true;
        let videoAnalysisInterval = null;
        let lastVideoAnalysisTime = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initSpeechRecognition();
            loadChats();
            renderSidebar();
            
            // Close dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.model-selector')) {
                    document.getElementById('modelDropdown').classList.remove('show');
                }
            });

            // Handle mobile keyboard
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    document.documentElement.style.setProperty('--vh', `${window.visualViewport.height}px`);
                });
            }
        });

        // Chat Management
        function loadChats() {
            const saved = localStorage.getItem('claude_chats');
            if (saved) {
                try {
                    chats = JSON.parse(saved);
                } catch (e) {
                    chats = [];
                }
            }
        }

        function saveChats() {
            localStorage.setItem('claude_chats', JSON.stringify(chats));
        }

        function renderSidebar() {
            const container = document.getElementById('sidebarChats');
            if (chats.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 14px;">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —á–∞—Ç–æ–≤</div>';
                return;
            }

            container.innerHTML = chats.map(chat => `
                <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                    <div class="chat-item-content">
                        <div class="chat-item-title">${escapeHtml(chat.title || '–ù–æ–≤—ã–π —á–∞—Ç')}</div>
                        <div class="chat-item-date">${formatDate(chat.updatedAt)}</div>
                    </div>
                    <button class="chat-item-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} —á –Ω–∞–∑–∞–¥`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)} –¥–Ω –Ω–∞–∑–∞–¥`;
            
            return date.toLocaleDateString('ru-RU');
        }

        function loadChat(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            
            currentChatId = chatId;
            messages = chat.messages || [];
            
            document.getElementById('welcomeScreen').style.display = messages.length === 0 ? 'flex' : 'none';
            renderMessages();
            renderSidebar();
            closeSidebar();
        }

        function deleteChat(chatId) {
            chats = chats.filter(c => c.id !== chatId);
            saveChats();
            
            if (currentChatId === chatId) {
                currentChatId = null;
                messages = [];
                document.getElementById('messagesContainer').innerHTML = '';
                document.getElementById('welcomeScreen').style.display = 'flex';
            }
            
            renderSidebar();
            showToast('–ß–∞—Ç —É–¥–∞–ª–µ–Ω');
        }

        function saveCurrentChat() {
            if (messages.length === 0) return;
            
            const title = generateChatTitle();
            
            if (currentChatId) {
                const chat = chats.find(c => c.id === currentChatId);
                if (chat) {
                    chat.messages = messages;
                    chat.updatedAt = Date.now();
                    if (!chat.title || chat.title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                        chat.title = title;
                    }
                }
            } else {
                currentChatId = 'chat_' + Date.now();
                chats.unshift({
                    id: currentChatId,
                    title: title,
                    messages: messages,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                });
            }
            
            saveChats();
            renderSidebar();
        }

        function generateChatTitle() {
            const firstUserMsg = messages.find(m => m.role === 'user');
            if (!firstUserMsg) return '–ù–æ–≤—ã–π —á–∞—Ç';
            
            let content = typeof firstUserMsg.content === 'string' 
                ? firstUserMsg.content 
                : firstUserMsg.content.find(c => c.type === 'text')?.text || '';
            
            return content.slice(0, 40) + (content.length > 40 ? '...' : '');
        }

        // Sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebarOverlay').classList.toggle('show');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebarOverlay').classList.remove('show');
        }

        // Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ru-RU';

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    if (isVoiceMode) {
                        document.getElementById('voiceText').textContent = finalTranscript || interimTranscript;
                    }

                    if (finalTranscript && isVoiceMode) {
                        handleVoiceInput(finalTranscript);
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'not-allowed') {
                        showToast('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω');
                    }
                };

                recognition.onend = () => {
                    if (isVoiceMode && isListening && isMicEnabled && !isSpeaking) {
                        recognition.start();
                    }
                };
            }
        }

        // Voice Mode
        function startVoiceMode() {
            if (!recognition) {
                showToast('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                return;
            }

            isVoiceMode = true;
            isListening = true;
            document.getElementById('voiceOverlay').classList.add('active');
            document.getElementById('voiceVisualizer').classList.add('listening');
            document.getElementById('voiceStatus').textContent = '–°–ª—É—à–∞—é...';
            document.getElementById('voiceText').textContent = '';
            document.getElementById('voiceResponse').style.display = 'none';
            
            try {
                recognition.start();
            } catch (e) {
                console.log('Recognition already started');
            }
        }

        function closeVoiceMode() {
            isVoiceMode = false;
            isListening = false;
            document.getElementById('voiceOverlay').classList.remove('active');
            document.getElementById('voiceVisualizer').classList.remove('listening', 'speaking', 'analyzing');
            
            if (recognition) {
                recognition.stop();
            }
            
            synthesis.cancel();
            
            stopVideoAnalysis();
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            isVideoEnabled = false;
            document.getElementById('videoContainer').classList.remove('active');
            document.getElementById('videoToggle').classList.remove('active');
        }

        async function toggleVideo() {
            const videoToggle = document.getElementById('videoToggle');
            const videoContainer = document.getElementById('videoContainer');
            const video = document.getElementById('videoPreview');

            if (!isVideoEnabled) {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
                    video.srcObject = mediaStream;
                    videoContainer.classList.add('active');
                    videoToggle.classList.add('active');
                    isVideoEnabled = true;
                    
                    // –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
                    startVideoAnalysis();
                    showToast('–ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞. AI –≤–∏–¥–∏—Ç –≤–∞—Å!');
                } catch (e) {
                    showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
                }
            } else {
                stopVideoAnalysis();
                
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                videoContainer.classList.remove('active');
                videoToggle.classList.remove('active');
                isVideoEnabled = false;
            }
        }

        // –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞ —Å –≤–∏–¥–µ–æ
        function captureVideoFrame() {
            const video = document.getElementById('videoPreview');
            if (!video || !video.videoWidth) return null;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            return canvas.toDataURL('image/jpeg', 0.7);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ
        function startVideoAnalysis() {
            if (videoAnalysisInterval) return;
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–ª—á–∏—Ç
            videoAnalysisInterval = setInterval(async () => {
                if (!isVoiceMode || !isVideoEnabled || isGenerating || isSpeaking) return;
                
                const now = Date.now();
                if (now - lastVideoAnalysisTime < 8000) return; // –ù–µ —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ 8 —Å–µ–∫
                
                lastVideoAnalysisTime = now;
                await analyzeVideoFrame();
            }, 5000);
        }

        function stopVideoAnalysis() {
            if (videoAnalysisInterval) {
                clearInterval(videoAnalysisInterval);
                videoAnalysisInterval = null;
            }
        }

        async function analyzeVideoFrame() {
            const frameData = captureVideoFrame();
            if (!frameData) return;
            
            const visualizer = document.getElementById('voiceVisualizer');
            visualizer.classList.remove('listening');
            visualizer.classList.add('analyzing');
            document.getElementById('voiceStatus').textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∏–¥–µ–æ...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: [
                            {
                                role: 'system',
                                content: '–¢—ã –≤–∏–¥–∏—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –∫–∞–º–µ—Ä—É. –ö–æ—Ä–æ—Ç–∫–æ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ø—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —á—Ç–æ –≤–∏–¥–∏—à—å –∏–ª–∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º.'
                            },
                            {
                                role: 'user',
                                content: [
                                    { type: 'image_url', image_url: { url: frameData } },
                                    { type: 'text', text: '–ß—Ç–æ —Ç—ã –≤–∏–¥–∏—à—å?' }
                                ]
                            }
                        ],
                        max_tokens: 150
                    })
                });

                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                const aiResponse = data.choices?.[0]?.message?.content || '';
                
                if (aiResponse && isVoiceMode) {
                    document.getElementById('voiceResponse').textContent = aiResponse;
                    document.getElementById('voiceResponse').style.display = 'block';
                    speakResponse(aiResponse);
                }
            } catch (e) {
                console.error('Video analysis error:', e);
                visualizer.classList.remove('analyzing');
                visualizer.classList.add('listening');
                document.getElementById('voiceStatus').textContent = '–°–ª—É—à–∞—é...';
            }
        }

        function toggleMic() {
            const micToggle = document.getElementById('micToggle');
            isMicEnabled = !isMicEnabled;
            
            if (isMicEnabled) {
                micToggle.classList.add('active');
                document.getElementById('voiceStatus').textContent = '–°–ª—É—à–∞—é...';
                document.getElementById('voiceVisualizer').classList.add('listening');
                if (isVoiceMode && !isSpeaking) {
                    try {
                        recognition.start();
                    } catch (e) {}
                }
            } else {
                micToggle.classList.remove('active');
                document.getElementById('voiceStatus').textContent = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω';
                document.getElementById('voiceVisualizer').classList.remove('listening');
                recognition.stop();
            }
        }

        async function handleVoiceInput(text) {
            if (!text.trim() || isGenerating) return;

            isListening = false;
            recognition.stop();
            
            document.getElementById('voiceStatus').textContent = '–î—É–º–∞—é...';
            document.getElementById('voiceVisualizer').classList.remove('listening');
            document.getElementById('voiceVisualizer').classList.add('analyzing');
            document.getElementById('voiceText').textContent = text;

            // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–∞–¥—Ä –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤–∏–¥–µ–æ
            let frameData = null;
            if (isVideoEnabled) {
                frameData = captureVideoFrame();
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            let messageContent;
            if (frameData) {
                messageContent = [
                    { type: 'image_url', image_url: { url: frameData } },
                    { type: 'text', text: text }
                ];
            } else {
                messageContent = text;
            }

            // Add user message
            messages.push({ role: 'user', content: messageContent });
            renderMessages();
            saveCurrentChat();

            // Get AI response
            try {
                const response = await getVoiceAIResponse(messageContent);
                if (response && isVoiceMode) {
                    document.getElementById('voiceResponse').textContent = response;
                    document.getElementById('voiceResponse').style.display = 'block';
                    speakResponse(response);
                }
            } catch (e) {
                console.error(e);
                if (isVoiceMode) {
                    document.getElementById('voiceStatus').textContent = '–û—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
                    document.getElementById('voiceVisualizer').classList.remove('analyzing');
                    setTimeout(() => {
                        if (isVoiceMode && isMicEnabled) {
                            isListening = true;
                            recognition.start();
                            document.getElementById('voiceVisualizer').classList.add('listening');
                            document.getElementById('voiceStatus').textContent = '–°–ª—É—à–∞—é...';
                        }
                    }, 2000);
                }
            }
        }

        // –û—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ (–±–µ–∑ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
        async function getVoiceAIResponse(content) {
            isGenerating = true;
            
            try {
                const apiMessages = messages.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: apiMessages,
                        stream: false
                    })
                });

                if (!response.ok) throw new Error('API error');
                
                const data = await response.json();
                const aiResponse = data.choices?.[0]?.message?.content || '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                messages.push({ role: 'assistant', content: aiResponse });
                renderMessages();
                saveCurrentChat();
                
                isGenerating = false;
                return aiResponse;
            } catch (e) {
                isGenerating = false;
                throw e;
            }
        }

        function speakResponse(text) {
            // Clean text from markdown
            const cleanText = text
                .replace(/```[\s\S]*?```/g, '–±–ª–æ–∫ –∫–æ–¥–∞')
                .replace(/`[^`]+`/g, '')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/[-*+]\s/g, '')
                .replace(/\n{2,}/g, '. ')
                .replace(/\n/g, ' ')
                .trim();

            if (!cleanText) {
                resumeListening();
                return;
            }

            isSpeaking = true;
            const visualizer = document.getElementById('voiceVisualizer');
            visualizer.classList.remove('listening', 'analyzing');
            visualizer.classList.add('speaking');
            document.getElementById('voiceStatus').textContent = '–û—Ç–≤–µ—á–∞—é...';

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ru-RU';
            utterance.rate = 1.05;
            utterance.pitch = 1;

            // Get Russian voice if available
            const voices = synthesis.getVoices();
            const ruVoice = voices.find(v => v.lang.startsWith('ru'));
            if (ruVoice) {
                utterance.voice = ruVoice;
            }

            utterance.onend = () => {
                isSpeaking = false;
                resumeListening();
            };

            utterance.onerror = () => {
                isSpeaking = false;
                resumeListening();
            };

            synthesis.speak(utterance);
        }

        function resumeListening() {
            if (isVoiceMode && isMicEnabled) {
                isListening = true;
                const visualizer = document.getElementById('voiceVisualizer');
                visualizer.classList.remove('speaking', 'analyzing');
                visualizer.classList.add('listening');
                document.getElementById('voiceStatus').textContent = '–°–ª—É—à–∞—é...';
                document.getElementById('voiceText').textContent = '';
                try {
                    recognition.start();
                } catch (e) {}
            }
        }

        // Model selection
        function toggleModelDropdown() {
            document.getElementById('modelDropdown').classList.toggle('show');
        }

        function selectModel(model, name) {
            currentModel = model;
            document.getElementById('selectedModel').textContent = name;
            
            document.querySelectorAll('.model-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-model="${model}"]`).classList.add('selected');
            
            document.getElementById('modelDropdown').classList.remove('show');
            showToast(`–ú–æ–¥–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${name}`);
        }

        // Image handling
        function triggerImageUpload() {
            document.getElementById('imageInput').click();
        }

        function handleImageSelect(event) {
            const files = event.target.files;
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        attachedImages.push(e.target.result);
                        renderImagePreviews();
                    };
                    reader.readAsDataURL(file);
                }
            }
            event.target.value = '';
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            if (attachedImages.length === 0) {
                container.classList.remove('show');
                container.innerHTML = '';
                return;
            }

            container.classList.add('show');
            container.innerHTML = attachedImages.map((img, i) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="Preview">
                    <button class="image-preview-remove" onclick="removeImage(${i})">√ó</button>
                </div>
            `).join('');
        }

        function removeImage(index) {
            attachedImages.splice(index, 1);
            renderImagePreviews();
        }

        // Message handling
        function sendSuggestion(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if ((!text && attachedImages.length === 0) || isGenerating) return;

            // Hide welcome screen
            document.getElementById('welcomeScreen').style.display = 'none';

            // Build message content
            let content;
            if (attachedImages.length > 0) {
                content = [];
                attachedImages.forEach(img => {
                    content.push({
                        type: 'image_url',
                        image_url: { url: img }
                    });
                });
                if (text) {
                    content.push({ type: 'text', text: text });
                }
            } else {
                content = text;
            }

            // Add user message
            messages.push({
                role: 'user',
                content: content,
                images: [...attachedImages]
            });

            // Clear input
            input.value = '';
            input.style.height = 'auto';
            attachedImages = [];
            renderImagePreviews();

            renderMessages();
            await getAIResponse(text);
        }

        async function getAIResponse(userText, voiceMode = false) {
            isGenerating = true;
            updateUIState();

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            const container = document.getElementById('messagesContainer');
            container.innerHTML += `
                <div class="message assistant" id="${loadingId}">
                    <div class="message-header">
                        <div class="message-avatar ai">C</div>
                        <span class="message-role">Claude</span>
                    </div>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            scrollToBottom();

            abortController = new AbortController();

            try {
                // Prepare messages for API
                const apiMessages = messages.map(msg => {
                    if (Array.isArray(msg.content)) {
                        return { role: msg.role, content: msg.content };
                    }
                    return { role: msg.role, content: msg.content };
                });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: currentModel,
                        messages: apiMessages,
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let thinkingContent = '';
                let isThinking = false;

                // Replace loading with actual message
                const loadingEl = document.getElementById(loadingId);
                loadingEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar ai">C</div>
                        <span class="message-role">Claude</span>
                    </div>
                    <div class="message-content" id="response-${loadingId}"></div>
                `;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') continue;

                            try {
                                const parsed = JSON.parse(data);
                                
                                // Handle content blocks
                                if (parsed.choices?.[0]?.delta?.content_blocks) {
                                    for (const block of parsed.choices[0].delta.content_blocks) {
                                        if (block.type === 'thinking') {
                                            isThinking = true;
                                            thinkingContent += block.thinking || '';
                                        } else if (block.type === 'text') {
                                            fullResponse += block.text || '';
                                        }
                                    }
                                }
                                
                                // Handle regular content
                                if (parsed.choices?.[0]?.delta?.content) {
                                    fullResponse += parsed.choices[0].delta.content;
                                }

                                // Render current state
                                renderStreamingResponse(loadingId, fullResponse, thinkingContent);
                                scrollToBottom();
                            } catch (e) {
                                // Skip invalid JSON
                            }
                        }
                    }
                }

                // Add to messages
                messages.push({
                    role: 'assistant',
                    content: fullResponse,
                    thinking: thinkingContent
                });

                // Final render with actions
                renderMessages();
                saveCurrentChat();

                isGenerating = false;
                updateUIState();

                return fullResponse;

            } catch (error) {
                if (error.name === 'AbortError') {
                    showToast('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                } else {
                    console.error('Error:', error);
                    showToast('–û—à–∏–±–∫–∞: ' + error.message);
                }

                const loadingEl = document.getElementById(loadingId);
                if (loadingEl) loadingEl.remove();

                isGenerating = false;
                updateUIState();
                return null;
            }
        }

        function renderStreamingResponse(id, content, thinking) {
            const el = document.getElementById(`response-${id}`);
            if (!el) return;

            let html = '';
            
            if (thinking) {
                html += `
                    <div class="thinking-block">
                        <div class="thinking-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                            –†–∞–∑–º—ã—à–ª–µ–Ω–∏–µ
                        </div>
                        <div class="thinking-content">${escapeHtml(thinking)}</div>
                    </div>
                `;
            }

            html += renderMarkdown(content);
            el.innerHTML = html;
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = messages.map((msg, i) => {
                if (msg.role === 'user') {
                    let imagesHtml = '';
                    if (msg.images && msg.images.length > 0) {
                        imagesHtml = `<div class="attached-images">${msg.images.map(img => 
                            `<img src="${img}" class="attached-image" alt="Attached">`
                        ).join('')}</div>`;
                    }
                    
                    const textContent = Array.isArray(msg.content) 
                        ? msg.content.find(c => c.type === 'text')?.text || ''
                        : msg.content;
                    
                    return `
                        <div class="message user">
                            <div class="message-header">
                                <div class="message-avatar user">–í—ã</div>
                                <span class="message-role">–í—ã</span>
                            </div>
                            <div class="message-content">
                                ${imagesHtml}
                                ${escapeHtml(textContent)}
                            </div>
                        </div>
                    `;
                } else {
                    let thinkingHtml = '';
                    if (msg.thinking) {
                        thinkingHtml = `
                            <div class="thinking-block">
                                <div class="thinking-header">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 6v6l4 2"/>
                                    </svg>
                                    –†–∞–∑–º—ã—à–ª–µ–Ω–∏–µ
                                </div>
                                <div class="thinking-content">${escapeHtml(msg.thinking)}</div>
                            </div>
                        `;
                    }

                    return `
                        <div class="message assistant">
                            <div class="message-header">
                                <div class="message-avatar ai">C</div>
                                <span class="message-role">Claude</span>
                            </div>
                            <div class="message-content">
                                ${thinkingHtml}
                                ${renderMarkdown(msg.content)}
                            </div>
                            <div class="message-actions">
                                <button class="action-btn" onclick="copyMessage(${i})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button class="action-btn" onclick="speakMessage(${i})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                        <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                    </svg>
                                    –û–∑–≤—É—á–∏—Ç—å
                                </button>
                                <button class="action-btn" onclick="regenerateMessage(${i})">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M23 4v6h-6"/>
                                        <path d="M1 20v-6h6"/>
                                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                                    </svg>
                                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            addCopyButtonsToCode();
            scrollToBottom();
        }

        function renderMarkdown(text) {
            if (!text) return '';

            // Configure marked
            marked.setOptions({
                highlight: function(code, lang) {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });

            let html = marked.parse(text);

            // Handle math expressions
            // Block math: $$...$$
            html = html.replace(/\$\$([\s\S]+?)\$\$/g, (match, math) => {
                try {
                    return katex.renderToString(math.trim(), { displayMode: true });
                } catch (e) {
                    return match;
                }
            });

            // Inline math: $...$
            html = html.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                try {
                    return katex.renderToString(math.trim(), { displayMode: false });
                } catch (e) {
                    return match;
                }
            });

            // Handle fractions like 1/2, 3/4
            html = html.replace(/(\d+)\/(\d+)/g, (match, num, den) => {
                // Skip if inside code or katex
                return `<span class="fraction"><span class="numerator">${num}</span><span class="denominator">${den}</span></span>`;
            });

            return html;
        }

        function addCopyButtonsToCode() {
            document.querySelectorAll('pre').forEach(pre => {
                if (!pre.querySelector('.copy-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'copy-btn';
                    btn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                    btn.onclick = function() {
                        const code = pre.querySelector('code');
                        navigator.clipboard.writeText(code.textContent).then(() => {
                            btn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                            btn.classList.add('copied');
                            setTimeout(() => {
                                btn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                                btn.classList.remove('copied');
                            }, 2000);
                        });
                    };
                    pre.appendChild(btn);
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyMessage(index) {
            const msg = messages[index];
            const text = typeof msg.content === 'string' ? msg.content : 
                msg.content.find(c => c.type === 'text')?.text || '';
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        function speakMessage(index) {
            const msg = messages[index];
            const text = typeof msg.content === 'string' ? msg.content : 
                msg.content.find(c => c.type === 'text')?.text || '';
            
            synthesis.cancel();
            
            const cleanText = text
                .replace(/```[\s\S]*?```/g, '–±–ª–æ–∫ –∫–æ–¥–∞')
                .replace(/`[^`]+`/g, '')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
                .replace(/[-*+]\s/g, '')
                .replace(/\n{2,}/g, '. ')
                .replace(/\n/g, ' ')
                .trim();

            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'ru-RU';
            
            const voices = synthesis.getVoices();
            const ruVoice = voices.find(v => v.lang.startsWith('ru'));
            if (ruVoice) utterance.voice = ruVoice;
            
            synthesis.speak(utterance);
            showToast('–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
        }

        async function regenerateMessage(index) {
            if (isGenerating) return;
            
            // Remove all messages after the user message before this response
            messages = messages.slice(0, index);
            renderMessages();
            
            // Get last user message
            const lastUserMsg = messages[messages.length - 1];
            if (lastUserMsg && lastUserMsg.role === 'user') {
                const text = typeof lastUserMsg.content === 'string' ? lastUserMsg.content :
                    lastUserMsg.content.find(c => c.type === 'text')?.text || '';
                await getAIResponse(text);
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
            }
        }

        function updateUIState() {
            const sendBtn = document.getElementById('sendBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (isGenerating) {
                sendBtn.style.display = 'none';
                stopBtn.classList.add('show');
            } else {
                sendBtn.style.display = 'flex';
                stopBtn.classList.remove('show');
            }
        }

        function newChat() {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
            if (messages.length > 0) {
                saveCurrentChat();
            }
            
            currentChatId = null;
            messages = [];
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('welcomeScreen').style.display = 'flex';
            renderSidebar();
            closeSidebar();
            showToast('–ù–∞—á–∞—Ç –Ω–æ–≤—ã–π —á–∞—Ç');
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Load voices
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => {};
        }
    </script>
</body>
</html>
